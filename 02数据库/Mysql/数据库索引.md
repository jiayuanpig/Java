# 索引

## **索引的概念**

数据库索引，是数据库管理系统中一个排序的数据结构，可以帮助Mysql高效获取数据。索引的实现通常使用B树及其变种B+树。



## 索引的分类

从索引的定义方式和用途中来看分为五种索引：**主键索引（聚集索引、聚簇索引），唯一索引，普通索引（非聚集索引），全文索引、复合索引**。

无论任何类型，都是通过建立关键字与位置的对应关系来实现的。索引是通过关键字找对应的记录的地址。

以上类型的差异：对索引关键字的要求不同。

关键字：记录的部分数据（某个字段，某些字段，某个字段的一部分）。

- 普通索引（index）：对关键字没有要求。
- 唯一索引（unique index）：要求关键字不能重复。同时增加唯一约束。
- 主键索引（primary key）：要求关键字不能重复，也不能为NULL。同时增加主键约束。
- 全文索引（fulltext key）：关键字的来源不是所有字段的数据，而是从字段中提取的特别关键词。



关键字含义：可以是某个字段，也可以是某些字段。如果一个索引通过在多个字段上提取的关键字，称之为**复合索引**。 命令:alter table exp add index (field1, field2);

注意：这里主键索引和唯一索引的区别在于：主键索引不能为空值，唯一索引允许空值；主键索引在一张表内只能创建一个，唯一索引可以创建多个。主键索引肯定是唯一索引，但唯一索引不一定是主键索引。



**使用索引注意的问题**

- 不要过度索引。索引越多，占用空间越大，反而性能变慢；
- 只对WHERE子句中频繁使用的建立索引；
- 尽可能使用唯一索引，重复值越少，索引效果越强；
- 使用短索引，如果char(255)太大，应该给它指定一个前缀长度，大部分情况下前10位或20位值基本是唯一的，那么就不要对整个列进行索引；
- 充分利用左前缀，这是针对复合索引，因为WHERE语句如果有AND并列，只能识别一个索引(获取记录最少的那个)，索引需要使用复合索引，那么应该将WHERE最频繁的放置在左边。
- 索引存在，如果没有满足使用原则，也会导致索引无效







## **索引的作用**

协助快速查询、更新数据库表中数据。

为表设置索引要付出代价的：

- 一是增加了数据库的存储空间
- 二是在插入和修改数据时要花费较多的时间(因为索引也要随之变动)。



## 创建索引

三种方式

方式1：

```sql
create index indexName on tableName(fieldName);
```

方式2：建表时指定索引

```sql
create table t_301(
            tid int,
            tname varchar(20),
            gender varchar(1),
            index [indexName] (fieldName)
         );
```

方式3：

```sql
alter table tableName add unique index indexName (fieldName);
```





## **索引的优缺点**

**索引提高系统性能（优点）：**

1.通过创建唯一性索引，可以保证数据库表中每一行数据的唯一性。

2.可以大大加快数据的检索速度，这也是创建索引的最主要的原因。

3.可以加速表和表之间的连接，特别是在实现数据的参考完整性方面特别有意义。

4.在使用分组和排序子句进行数据检索时，同样可以显著减少查询中分组和排序的时间。

5.通过使用索引，可以在查询的过程中，使用优化隐藏器，提高系统的性能。

**增加索引也有许多不利的方面(缺点)：**

1.创建索引和维护索引要耗费时间，这种时间随着数据量的增加而增加。

2.索引需要占物理空间，除了数据表占数据空间之外，每一个索引还要占一定的物理空间，如果要建立聚簇索引，那么需要的空间就会更大。

3.当对表中的数据进行增加、删除和修改的时候，索引也要动态的维护，这样就降低了数据的维护速度。



## **索引的应用场景**

**什么时候需要创建索引？**

- **主键自动创建索引**
- 频繁作为查询条件的字段应该创建索引
- 外键关系建立索引，加快连接速度
- 单键/组合索引的选择问题，组合索引性价比更高
- 查询中统计或分组字段
- 根据范围进行搜索的情况

总的来说，索引是建立在数据库表中的某些列的上面。**唯一、不为空、经常被查询的字段更适合建立索引**



**对于有些列不应该创建索引：**

（1）对于那些在查询中很少使用或者参考的列不应该创建索引。

这是因为，既然这些列很少使用到，因此有索引或者无索引，并不能提高查询速度。相反，由于增加了索引，反而降低了系统的维护速度和增大了空间需求。

（2）对于那些只有很少数据值的列也不应该增加索引。

这是因为，由于这些列的取值很少，例如人事表的性别列，在查询的结果中，结果集的数据行占了表中数据行的很大比例，即需要在表中搜索的数据行的比例很大。增加索引，并不能明显加快检索速度。

（3）对于那些定义为text, image和bit数据类型的列不应该增加索引。

这是因为，这些列的数据量要么相当大，要么取值很少。

（4）当修改性能远远大于检索性能时，不应该创建索引。

这是因为，修改性能和检索性能是互相矛盾的。当增加索引时，会提高检索性能，但是会降低修改性能。当减少索引时，会提高修改性能，降低检索性能。因此，当修改性能远远大于检索性能时，不应该创建索引。

（5）经常增删改的字段或表

（6）where条件用不到的字段

（7）过滤性不好的字段



## 索引实现

包括Hash索引和B+树索引

**Hash索引和B+树索引的特点：**

- Hash索引结构的特殊性，其检索效率非常高，索引的检索可以一次定位;
- B+树索引需要从根节点到枝节点，最后才能访问到页节点这样多次的IO访问;

**为什么不都用Hash索引而使用B+树索引？**

1. **Hash索引仅仅能满足"=","IN"和""查询，不能使用范围查询**,因为经过相应的Hash算法处理之后的Hash值的大小关系，并不能保证和Hash运算前完全一样；
2. Hash索引无法被用来避免数据的排序操作，因为Hash值的大小关系并不一定和Hash运算前的键值完全一样；
3. Hash索引不能利用部分索引键查询，对于组合索引，Hash索引在计算Hash值的时候是组合索引键合并后再一起计算Hash值，而不是单独计算Hash值，所以通过组合索引的前面一个或几个索引键进行查询的时候，Hash索引也无法被利用；
4. Hash索引在任何时候都不能避免表扫描，由于不同索引键存在相同Hash值，所以即使取满足某个Hash键值的数据的记录条数，也无法从Hash索引中直接完成查询，还是要回表查询数据；
5. **Hash索引遇到大量Hash值相等的情况后性能并不一定就会比B+树索引高**。



**补充：**

1.MySQL中，只有HEAP/MEMORY引擎才显示支持Hash索引。

2.**常用的InnoDB引擎中默认使用的是B+树索引**，它会实时监控表上索引的使用情况，如果认为建立哈希索引可以提高查询效率，则自动在内存中的“自适应哈希索引缓冲区”建立哈希索引（在InnoDB中默认开启自适应哈希索引），通过观察搜索模式，MySQL会利用index key的前缀建立哈希索引，如果一个表几乎大部分都在缓冲池中，那么建立一个哈希索引能够加快等值查询。

3.如果是等值查询，那么哈希索引明显有绝对优势，因为只需要经过一次算法即可找到相应的键值；当然了，这个前提是，键值都是唯一的。如果键值不是唯一的，就需要先找到该键所在位置，然后再根据链表往后扫描，直到找到相应的数据；

4.如果是范围查询检索，这时候哈希索引就毫无用武之地了，因为原先是有序的键值，经过哈希算法后，有可能变成不连续的了，就没办法再利用索引完成范围查询检索；
同理，哈希索引没办法利用索引完成排序，以及like ‘xxx%’ 这样的部分模糊查询（这种部分模糊查询，其实本质上也是范围查询）；

5.哈希索引也不支持多列联合索引的最左匹配规则；

6.B+树索引的关键字检索效率比较平均，不像B树那样波动幅度大，在有大量重复键值情况下，哈希索引的效率也是极低的，因为存在所谓的哈希碰撞问题。

7.在大多数场景下，都会有范围查询、排序、分组等查询特征，用B+树索引就可以了。



**为什么说B+比B树更适合实际应用中操作系统的文件索引和数据库索引？**

> **1.B+的磁盘读写代价更低**
>
> B+的内部结点并没有指向关键字具体信息的指针。因此其内部结点相对B树更小。如果把所有同一内部结点的关键字存放在同一盘块中，那么盘块所能容纳的关键字数量也越多。一次性读入内存中的需要查找的关键字也就越多。相对来说IO读写次数也就降低了。
>
> **2.B+tree的查询效率更加稳定**
>
> 由于非终结点并不是最终指向文件内容的结点，而只是叶子结点中关键字的索引。所以任何关键字的查找必须走一条从根结点到叶子结点的路。所有关键字查询的路径长度相同，导致每一个数据的查询效率相当。





## 聚集索引和非聚集索引

**聚集索引(clustered index):**

聚集索引**表记录的排列顺序和索引的排列顺序一致，所以查询效率快，**只要找到第一个索引值记录，其余就连续性的记录在物理也一样连续存放。聚集索引对应的缺点就是修改慢，因为**为了保证表中记录的物理和索引顺序一致，在记录插入的时候，会对数据页重新排序**。
聚集索引类似于新华字典中用拼音去查找汉字，拼音检索表于书记顺序都是按照a~z排列的，就像相同的逻辑顺序于物理顺序一样，当你需要查找a,ai两个读音的字，或是想一次寻找多个傻(sha)的同音字时，也许向后翻几页，或紧接着下一行就得到结果了。

**非聚集索引(nonclustered index):**

非聚集索引**指定了表中记录的逻辑顺序，但是记录的物理和索引不一定一致，**两种索引都采用B+树结构，非聚集索引的叶子层并不和实际数据页相重叠，而采用叶子层包含一个指向表中的记录在数据页中的指针方式。**非聚集索引层次多，不会造成数据重排**。
非聚集索引类似在新华字典上通过偏旁部首来查询汉字，检索表也许是按照横、竖、撇来排列的，但是由于正文中是a~z的拼音顺序，所以就类似于逻辑地址于物理地址的不对应。同时适用的情况就在于分组，大数目的不同值，频繁更新的列中，这些情况即不适合聚集索引。

**根本区别：**

聚集索引和非聚集索引的根本区别是表记录的排列顺序和与索引的排列顺序是否一致。

